<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Add Benh Nhan</title>
    <link th:href="@{/resources/css/bootstrap.min.css}" rel="stylesheet">
    <style>
        .error-message {
            color: red;
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }

        .is-invalid {
            border-color: #dc3545;
        }
        
        .required-field::after {
            content: "*";
            color: red;
            margin-left: 4px;
        }
        
        .card {
            margin-bottom: 2rem;
            border: 1px solid #dee2e6;
            border-radius: 0.5rem;
        }

        .card-header {
            background-color: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            padding: 1rem 1.5rem;
        }
    </style>
</head>
<body>
<div class="container py-4">
    <div class="card">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <h3 class="mb-0">Th√™m B·ªánh Nh√¢n m·ªõi</h3>
                <a th:href="@{/benhnhan/list}" class="btn btn-outline-secondary">
                    Quay l·∫°i
                </a>
            </div>
        </div>
        <div class="card-body">
            <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show">
                <span th:text="${successMessage}"></span>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>

            <div id="errorMessage" th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show">
                <span th:text="${errorMessage}"></span>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            
            <form id="addBenhNhanForm" th:action="@{/benhnhan/addBenhNhan}" method="post" th:object="${benhNhan}" novalidate>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label for="maBenhNhan" class="form-label required-field">M√£ B·ªánh Nh√¢n</label>
                            <input type="text" class="form-control" id="maBenhNhan" th:field="*{maBenhNhan}" data-required="true">
                            <div class="error-message" id="maBenhNhan-error"></div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label for="tenBenhNhan" class="form-label required-field">T√™n B·ªánh Nh√¢n</label>
                            <input type="text" class="form-control" id="tenBenhNhan" th:field="*{tenBenhNhan}" data-required="true">
                            <div class="error-message" id="tenBenhNhan-error"></div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label for="soCMND" class="form-label required-field">S·ªë CMND</label>
                            <input type="text" class="form-control" id="soCMND" th:field="*{soCMND}" data-required="true">
                            <div class="error-message" id="soCMND-error"></div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label for="gioiTinh" class="form-label required-field">Gi·ªõi T√≠nh</label>
                            <select class="form-select" id="gioiTinh" th:field="*{gioiTinh}" data-required="true">
                                <option value="">Ch·ªçn gi·ªõi t√≠nh</option>
                                <option value="Nam">Nam</option>
                                <option value="N·ªØ">N·ªØ</option>
                            </select>
                            <div class="error-message" id="gioiTinh-error"></div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label for="ngaySinh" class="form-label required-field">Ng√†y Sinh</label>
                            <input type="date" class="form-control" id="ngaySinh" th:field="*{ngaySinh}" data-required="true">
                            <div class="error-message" id="ngaySinh-error"></div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label for="soDienThoai" class="form-label required-field">S·ªë ƒêi·ªán Tho·∫°i</label>
                            <input type="text" class="form-control" id="soDienThoai" th:field="*{soDienThoai}" data-required="true">
                            <div class="error-message" id="soDienThoai-error"></div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group mb-3">
                    <label for="diaChi" class="form-label required-field">ƒê·ªãa Ch·ªâ</label>
                    <input type="text" class="form-control" id="diaChi" th:field="*{diaChi}" data-required="true">
                    <div class="error-message" id="diaChi-error"></div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label for="tinhThanh" class="form-label required-field">T·ªânh Th√†nh</label>
                            <div class="input-group">
                                <select class="form-select" id="tinhThanh" th:field="*{tinhThanh.maTinhThanh}" data-required="true">
                                    <option value="">Ch·ªçn t·ªânh th√†nh</option>
                                    <option th:each="tinh : ${tinhThanhList}"
                                            th:value="${tinh.maTinhThanh}"
                                            th:text="${tinh.tenTinhThanh}">
                                    </option>
                                </select>
                                <a th:href="@{/tinh-thanh/them-moi}" class="btn btn-outline-secondary" title="Th√™m t·ªânh th√†nh m·ªõi">
                                    Th√™m m·ªõi
                                </a>
                            </div>
                            <div class="error-message" id="maTinhThanh-error"></div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label for="ngayCachLy" class="form-label required-field">Ng√†y C√°ch Ly</label>
                            <input type="date" class="form-control" id="ngayCachLy" th:field="*{ngayCachLy}" data-required="true">
                            <div class="error-message" id="ngayCachLy-error"></div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group mb-3">
                    <label for="donViDieuTri" class="form-label required-field">ƒê∆°n V·ªã ƒêi·ªÅu Tr·ªã</label>
                    <div class="input-group">
                        <select class="form-select" id="donViDieuTri" th:field="*{donViDieuTri.maDonVi}" data-required="true">
                            <option value="">Ch·ªçn ƒë∆°n v·ªã ƒëi·ªÅu tr·ªã</option>
                            <option th:each="donVi : ${donViList}"
                                    th:value="${donVi.maDonVi}"
                                    th:text="${donVi.tenDonVi}">
                            </option>
                        </select>
                        <a th:href="@{/don-vi-dieu-tri/them-moi}" class="btn btn-outline-secondary" title="Th√™m ƒë∆°n v·ªã ƒëi·ªÅu tr·ªã m·ªõi">
                            Th√™m m·ªõi
                        </a>
                    </div>
                    <div class="error-message" id="maDonVi-error"></div>
                </div>
                
                <div class="alert alert-info mt-3">
                    <strong>L∆∞u √Ω:</strong> ƒê·ªÉ th√™m ƒë∆°n v·ªã ƒëi·ªÅu tr·ªã, b·∫°n c·∫ßn ƒë·∫£m b·∫£o ƒë√£ c√≥ t·ªânh th√†nh li√™n quan trong h·ªá th·ªëng.
                </div>
                
                <div class="mt-4">
                    <button type="submit" class="btn btn-primary">Th√™m B·ªánh Nh√¢n</button>
                    <a th:href="@{/benhnhan/list}" class="btn btn-secondary">H·ªßy</a>
                </div>
            </form>
        </div>
    </div>
</div>

<script th:src="@{/resources/js/bootstrap.bundle.min.js}"></script>
<script>
    window.onload = function () {
        console.log("‚úÖ Script ch·∫°y!");


        
        // S·ª± ki·ªán khi thay ƒë·ªïi t·ªânh th√†nh

        document.getElementById('addBenhNhanForm').addEventListener('submit', function (event) {
            // Lu√¥n ngƒÉn h√†nh vi m·∫∑c ƒë·ªãnh tr∆∞·ªõc
            event.preventDefault();
            console.log("üìå Form submit triggered!");

            let isValid = true;
            let hasEmptyFields = false;

            // X√≥a t·∫•t c·∫£ th√¥ng b√°o l·ªói tr∆∞·ªõc khi ki·ªÉm tra
            document.querySelectorAll('.error-message').forEach(e => {
                e.textContent = '';
            });

            // X√≥a t·∫•t c·∫£ class is-invalid
            document.querySelectorAll('.is-invalid').forEach(e => {
                e.classList.remove('is-invalid');
            });

            // L·∫•y t·∫•t c·∫£ c√°c input v√† select c√≥ thu·ªôc t√≠nh data-required="true"
            const requiredInputs = document.querySelectorAll('input[data-required="true"], select[data-required="true"]');

            requiredInputs.forEach(input => {
                const value = input.value.trim();
                const fieldName = input.id;
                // T√¨m label theo attribute for
                const labelText = document.querySelector('label[for="' + fieldName + '"]')?.textContent || fieldName;
                const errorElement = document.getElementById(fieldName + '-error');

                if (!value) {
                    console.log(`‚ùå Field "${fieldName}" is empty.`);
                    hasEmptyFields = true;

                    // Hi·ªÉn th·ªã th√¥ng b√°o l·ªói
                    errorElement.textContent = `${labelText.replace('*', '')} kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng`;
                    input.classList.add('is-invalid');

                    isValid = false;
                }
            });

            // Ki·ªÉm tra ng√†y sinh
            const ngaySinh = document.getElementById('ngaySinh').value;
            const ngaySinhInput = document.getElementById('ngaySinh');
            const ngaySinhError = document.getElementById('ngaySinh-error');

            if (ngaySinh && new Date(ngaySinh) > new Date()) {
                console.log("‚ùå L·ªói ng√†y sinh!");
                ngaySinhError.textContent = 'Ng√†y sinh ph·∫£i nh·ªè h∆°n ng√†y hi·ªán t·∫°i';
                ngaySinhInput.classList.add('is-invalid');
                isValid = false;
            }

            // Ki·ªÉm tra m·ªëi quan h·ªá gi·ªØa t·ªânh th√†nh v√† ƒë∆°n v·ªã ƒëi·ªÅu tr·ªã
            const selectedTinhThanh = document.getElementById('tinhThanh').value;
            const selectedDonVi = document.getElementById('donViDieuTri').value;
            const donViError = document.getElementById('maDonVi-error');
            const donViSelect = document.getElementById('donViDieuTri');

            if (selectedTinhThanh && selectedDonVi) {
                // Ki·ªÉm tra n·∫øu ƒë∆°n v·ªã ƒëi·ªÅu tr·ªã kh√¥ng thu·ªôc t·ªânh th√†nh ƒë∆∞·ª£c ch·ªçn
                if (!Array.from(donViSelect.options).some(option => option.value === selectedDonVi)) {
                    donViError.textContent = 'ƒê∆°n v·ªã ƒëi·ªÅu tr·ªã kh√¥ng thu·ªôc t·ªânh th√†nh ƒë∆∞·ª£c ch·ªçn';
                    donViSelect.classList.add('is-invalid');
                    isValid = false;
                }
            }

            // Hi·ªÉn th·ªã c·∫£nh b√°o chung n·∫øu c√≥ tr∆∞·ªùng tr·ªëng
            if (hasEmptyFields) {
                // T·∫°o th√¥ng b√°o alert n·∫øu ch∆∞a c√≥
                if (!document.getElementById('general-error-alert')) {
                    const alertDiv = document.createElement('div');
                    alertDiv.id = 'general-error-alert';
                    alertDiv.className = 'alert alert-danger mt-3';
                    alertDiv.role = 'alert';
                    alertDiv.textContent = 'Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·ªánh nh√¢n tr∆∞·ªõc khi g·ª≠i!';

                    const formElement = document.getElementById('addBenhNhanForm');
                    formElement.parentNode.insertBefore(alertDiv, formElement.nextSibling);
                }
            } else {
                // X√≥a th√¥ng b√°o alert n·∫øu kh√¥ng c√≤n tr∆∞·ªùng tr·ªëng
                const existingAlert = document.getElementById('general-error-alert');
                if (existingAlert) {
                    existingAlert.remove();
                }
            }

            // Submit form ch·ªâ khi kh√¥ng c√≥ l·ªói
            if (isValid) {
                console.log("‚úÖ Kh√¥ng c√≥ l·ªói, form s·∫Ω submit!");
                this.submit(); // 'this' ·ªü ƒë√¢y tham chi·∫øu ƒë·∫øn form element
            } else {
                console.log("üö´ C√≥ l·ªói, ngƒÉn submit!");
                // Cu·ªôn trang l√™n v·ªã tr√≠ l·ªói ƒë·∫ßu ti√™n
                const firstError = document.querySelector('.is-invalid');
                if (firstError) {
                    firstError.focus();
                    firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        });
    };
</script>
</body>
</html>