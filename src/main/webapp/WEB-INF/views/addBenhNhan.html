<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Add Benh Nhan</title>
    <link th:href="@{resources/css/bootstrap.min.css}" rel="stylesheet">
    <style>
        .error-message {
            color: red;
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }

        .is-invalid {
            border-color: #dc3545;
        }
    </style>
</head>
<body>
<h1>Th√™m B·ªánh Nh√¢n m·ªõi</h1>
<div class="container mt-4">
    <div th:if="${successMessage}" class="alert alert-success"
         style="color: green; padding: 10px; margin: 10px 0; border: 1px solid green;">
        <span th:text="${successMessage}"></span>
    </div>

    <!-- Hi·ªÉn th·ªã th√¥ng b√°o l·ªói -->
    <div id="errorMessage" th:if="${errorMessage}" class="alert alert-danger"
         style="color: red; padding: 10px; margin: 10px 0; border: 1px solid red;">
        <span th:text="${errorMessage}"></span>
    </div>
    <form id="addBenhNhanForm" th:action="@{/benhnhan/addBenhNhan}" method="post" th:object="${benhNhan}" novalidate>
        <div class="form-group mb-3">
            <label for="maBenNhan">M√£ B·ªánh Nh√¢n</label>
            <input type="text" class="form-control" id="maBenNhan" th:field="*{maBenNhan}" data-required="true">
            <div class="error-message" id="maBenNhan-error"></div>
        </div>
        <div class="form-group mb-3">
            <label for="tenBenhNhan">T√™n B·ªánh Nh√¢n</label>
            <input type="text" class="form-control" id="tenBenhNhan" th:field="*{tenBenhNhan}" data-required="true">
            <div class="error-message" id="tenBenhNhan-error"></div>
        </div>
        <div class="form-group mb-3">
            <label for="soCMND">S·ªë CMND</label>
            <input type="text" class="form-control" id="soCMND" th:field="*{soCMND}" data-required="true">
            <div class="error-message" id="soCMND-error"></div>
        </div>
        <div class="form-group mb-3">
            <label for="gioiTinh">Gi·ªõi T√≠nh</label>
            <input type="text" class="form-control" id="gioiTinh" th:field="*{gioiTinh}" data-required="true">
            <div class="error-message" id="gioiTinh-error"></div>
        </div>
        <div class="form-group mb-3">
            <label for="ngaySinh">Ng√†y Sinh</label>
            <input type="date" class="form-control" id="ngaySinh" th:field="*{ngaySinh}" data-required="true">
            <div class="error-message" id="ngaySinh-error"></div>
        </div>
        <div class="form-group mb-3">
            <label for="diaChi">ƒê·ªãa Ch·ªâ</label>
            <input type="text" class="form-control" id="diaChi" th:field="*{diaChi}" data-required="true">
            <div class="error-message" id="diaChi-error"></div>
        </div>
        <div class="form-group mb-3">
            <label for="soDienThoai">S·ªë ƒêi·ªán Tho·∫°i</label>
            <input type="text" class="form-control" id="soDienThoai" th:field="*{soDienThoai}" data-required="true">
            <div class="error-message" id="soDienThoai-error"></div>
        </div>
        <div class="form-group mb-3">
            <label for="maTinhThanh">M√£ T·ªânh Th√†nh</label>
            <input type="text" class="form-control" id="maTinhThanh" th:field="*{tinhThanh.maTinhThanh}" data-required="true">
            <div class="error-message" id="maTinhThanh-error"></div>
        </div>
        <div class="form-group mb-3">
            <label for="ngayCachLy">Ng√†y C√°ch Ly</label>
            <input type="date" class="form-control" id="ngayCachLy" th:field="*{ngayCachLy}" data-required="true">
            <div class="error-message" id="ngayCachLy-error"></div>
        </div>
        <div class="form-group mb-3">
            <label for="maDonVi">M√£ ƒê∆°n V·ªã</label>
            <input type="text" class="form-control" id="maDonVi" th:field="*{donViDieuTri.maDonVi}" data-required="true">
            <div class="error-message" id="maDonVi-error"></div>
        </div>
        <button type="submit" class="btn btn-primary">Th√™m B·ªánh Nh√¢n</button>
    </form>
</div>

<script th:src="@{resources/js/bootstrap.bundle.min.js}"></script>
<script>
    window.onload = function () {
        console.log("‚úÖ Script ch·∫°y!");

        document.getElementById('addBenhNhanForm').addEventListener('submit', function (event) {
            // Lu√¥n ngƒÉn h√†nh vi m·∫∑c ƒë·ªãnh tr∆∞·ªõc
            event.preventDefault();
            console.log("üìå Form submit triggered!");

            let isValid = true;
            let hasEmptyFields = false;

            // X√≥a t·∫•t c·∫£ th√¥ng b√°o l·ªói tr∆∞·ªõc khi ki·ªÉm tra
            document.querySelectorAll('.error-message').forEach(e => {
                e.textContent = '';
            });

            // X√≥a t·∫•t c·∫£ class is-invalid
            document.querySelectorAll('.is-invalid').forEach(e => {
                e.classList.remove('is-invalid');
            });

            // L·∫•y t·∫•t c·∫£ c√°c input c√≥ thu·ªôc t√≠nh data-required="true"
            const requiredInputs = document.querySelectorAll('input[data-required="true"]');

            requiredInputs.forEach(input => {
                const value = input.value.trim();
                const fieldName = input.id;
                const labelText = input.previousElementSibling.textContent; // L·∫•y n·ªôi dung t·ª´ nh√£n
                const errorElement = document.getElementById(fieldName + '-error');

                if (!value) {
                    console.log(`‚ùå Field "${fieldName}" is empty.`);
                    hasEmptyFields = true;

                    // Hi·ªÉn th·ªã th√¥ng b√°o l·ªói
                    errorElement.textContent = `${labelText} kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng`;
                    input.classList.add('is-invalid');

                    isValid = false;
                }
            });

            // Hi·ªÉn th·ªã c·∫£nh b√°o chung n·∫øu c√≥ tr∆∞·ªùng tr·ªëng
            if (hasEmptyFields) {
                // T·∫°o th√¥ng b√°o alert n·∫øu ch∆∞a c√≥
                if (!document.getElementById('general-error-alert')) {
                    const alertDiv = document.createElement('div');
                    alertDiv.id = 'general-error-alert';
                    alertDiv.className = 'alert alert-danger mt-3';
                    alertDiv.role = 'alert';
                    alertDiv.textContent = 'Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·ªánh nh√¢n tr∆∞·ªõc khi g·ª≠i!';

                    const formElement = document.getElementById('addBenhNhanForm');
                    formElement.parentNode.insertBefore(alertDiv, formElement);
                }
            } else {
                // X√≥a th√¥ng b√°o alert n·∫øu kh√¥ng c√≤n tr∆∞·ªùng tr·ªëng
                const existingAlert = document.getElementById('general-error-alert');
                if (existingAlert) {
                    existingAlert.remove();
                }
            }

            // Ki·ªÉm tra ng√†y sinh
            const ngaySinh = document.getElementById('ngaySinh').value;
            const ngaySinhInput = document.getElementById('ngaySinh');
            const ngaySinhError = document.getElementById('ngaySinh-error');

            if (ngaySinh && new Date(ngaySinh) > new Date()) {
                console.log("‚ùå L·ªói ng√†y sinh!");
                ngaySinhError.textContent = 'Ng√†y sinh ph·∫£i nh·ªè h∆°n ng√†y hi·ªán t·∫°i';
                ngaySinhInput.classList.add('is-invalid');
                isValid = false;
            }

            // Submit form ch·ªâ khi kh√¥ng c√≥ l·ªói
            if (isValid) {
                console.log("‚úÖ Kh√¥ng c√≥ l·ªói, form s·∫Ω submit!");
                this.submit(); // 'this' ·ªü ƒë√¢y tham chi·∫øu ƒë·∫øn form element
            } else {
                console.log("üö´ C√≥ l·ªói, ngƒÉn submit!");
                // Cu·ªôn trang l√™n v·ªã tr√≠ l·ªói ƒë·∫ßu ti√™n
                const firstError = document.querySelector('.is-invalid');
                if (firstError) {
                    firstError.focus();
                    firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        });
    };
</script>
</body>
</html>